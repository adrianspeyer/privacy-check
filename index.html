<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#3B82F6">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Privacy Check">
<meta name="description" content="Audit your digital footprint. See what your phone reveals.">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" href="data:,"> 

<title>Privacy Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/adrianspeyer/speyer-ui@2.0.7/dist/sui-tokens.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/adrianspeyer/speyer-ui@2.0.7/dist/sui-components.min.css">
<script src="https://cdn.jsdelivr.net/gh/adrianspeyer/speyer-ui@2.0.7/dist/sui.min.js" defer></script>

<style>
/* ‚îÄ‚îÄ PWA Physics ‚îÄ‚îÄ */
body, html { position: fixed; width: 100%; height: 100%; overflow: hidden; background: var(--sui-bg-primary); -webkit-user-select: none; user-select: none; touch-action: pan-y; }
.app-scroller { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: env(safe-area-inset-bottom); overscroll-behavior-y: none; }
.app-wrap { max-width: 640px; margin: 0 auto; padding: 0 var(--sui-space-3) 160px; }

/* ‚îÄ‚îÄ Sticky Action Bar ‚îÄ‚îÄ */
.action-bar { position: sticky; top: 0; z-index: 999; display: flex; justify-content: space-between; align-items: center; padding: 12px var(--sui-space-3); margin: 0 -16px; padding-left: calc(var(--sui-space-3) + env(safe-area-inset-left)); padding-right: calc(var(--sui-space-3) + env(safe-area-inset-right)); padding-top: calc(12px + env(safe-area-inset-top)); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid var(--sui-border); }
[data-theme="dark"] .action-bar { background: rgba(11, 15, 26, 0.95); }
.btn-rescan { background: var(--sui-blue-primary); color: white; border: none; border-radius: 24px; padding: 8px 18px; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: var(--sui-shadow-sm); cursor: pointer; }
.btn-rescan:active { transform: scale(0.96); }
.btn-rescan svg { width: 18px; height: 18px; }

/* ‚îÄ‚îÄ UI Components ‚îÄ‚îÄ */
.hero { text-align: center; padding: var(--sui-space-5) var(--sui-space-3) 24px; }
.hero-icon { width: 64px; height: 64px; margin: 0 auto 16px; border-radius: var(--sui-radius-lg); background: var(--sui-blue-soft); border: 1px solid var(--sui-border); display: flex; align-items: center; justify-content: center; font-size: 30px; }

/* Report Card */
.rc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
.rc-col { text-align: center; padding: 16px; background: var(--sui-bg-elevated); border-radius: var(--sui-radius-lg); border: 1px solid var(--sui-border); }
.rc-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--sui-text-muted); letter-spacing: 0.05em; margin-bottom: 8px; }
.rc-val-big { font-family: var(--sui-font-mono); font-size: 42px; font-weight: 700; line-height: 1; }
.rc-sub { font-size: 12px; color: var(--sui-text-secondary); margin-top: 6px; font-weight: 500; }

/* Headers */
.sec-header { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--sui-text-muted); margin: 32px 0 12px; padding-left: 4px; display: flex; align-items: center; gap: 8px; }
.sec-line { height: 1px; background: var(--sui-border); flex: 1; }

/* Action Plan Box */
.action-plan { background: var(--sui-bg-card); border: 1px solid var(--sui-border); border-radius: var(--sui-radius-lg); padding: 16px; margin-top: 24px; box-shadow: var(--sui-shadow-sm); }
.ap-title { font-weight: 700; font-size: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

/* Data Items */
.d-item { background: var(--sui-bg-elevated); border: 1px solid var(--sui-border); border-radius: var(--sui-radius-md); margin-bottom: 16px; overflow: hidden; }
.d-row { display: flex; align-items: flex-start; padding: 16px; gap: 16px; }
.d-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 6px; }
.d-dot-h { background: var(--sui-error); }
.d-dot-m { background: var(--sui-warning); }
.d-dot-s { background: var(--sui-success); }
.d-dot-l { background: var(--sui-info); opacity: 0.5; } 

.d-key { font-size: 14px; color: var(--sui-text-secondary); flex-shrink: 0; min-width: 110px; font-weight: 600; }
.d-val { font-family: var(--sui-font-mono); font-size: 14px; color: var(--sui-blue-active); text-align: right; flex: 1; overflow-wrap: anywhere; line-height: 1.6; }
.d-why { padding: 12px 16px; background: rgba(0,0,0,0.03); font-size: 13px; color: var(--sui-text-primary); border-top: 1px solid var(--sui-border); line-height: 1.5; }
.d-why-label { font-weight: 700; font-size: 11px; text-transform: uppercase; color: var(--sui-text-muted); display: block; margin-bottom: 4px; letter-spacing: 0.05em; }

/* Mobile Stack */
@media (max-width: 480px) {
  .d-row { flex-direction: column; gap: 6px; }
  .d-key { min-width: auto; margin-bottom: 2px; color: var(--sui-text-muted); font-size: 12px; text-transform: uppercase; letter-spacing:0.05em;}
  .d-val { text-align: left; width: 100%; font-size: 15px; }
  .d-dot { display: none; } 
  .d-item { border-left: 4px solid transparent; }
  .d-item.risk-h { border-left-color: var(--sui-error); }
  .d-item.risk-m { border-left-color: var(--sui-warning); }
  .d-item.risk-s { border-left-color: var(--sui-success); }
  .d-item.risk-l { border-left-color: var(--sui-border); }
}

.edu-box { background: var(--sui-blue-soft); border: 1px solid var(--sui-blue-focus); padding: 16px; border-radius: var(--sui-radius-md); margin-bottom: 16px; font-size: 14px; color: var(--sui-text-primary); line-height: 1.5; display: flex; gap: 12px; }
.edu-icon { font-size: 20px; flex-shrink: 0; margin-top: 0; }
.perm-btn { width: 100%; margin-bottom: 12px; justify-content: flex-start; border-style: dashed; padding: 14px; height: auto; }
.perm-btn.granted { border-style: solid; border-color: var(--sui-success); background: var(--sui-success-soft); color: var(--sui-success-strong); }
.perm-btn.protected { border-style: solid; border-color: var(--sui-success); background: var(--sui-bg-elevated); color: var(--sui-text-secondary); pointer-events: none; }

/* Toast */
.sui-toast-container { z-index: 2000 !important; top: 80px !important; }
.update-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); z-index: 2000; transition: transform 0.3s ease-out; width: 90%; max-width: 400px; }
.update-toast.visible { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div id="update-toast" class="sui-toast sui-toast-info update-toast">
  <div class="sui-toast-icon">‚ú®</div>
  <div class="sui-toast-content">
    <div class="sui-toast-title">Update Available</div>
    <div class="sui-toast-message">New version ready.</div>
  </div>
  <button class="sui-btn sui-btn-sm sui-btn-primary" id="btn-update">Update</button>
</div>

<div class="app-scroller">
  <div class="action-bar">
    <button class="btn-rescan" id="global-rescan">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
      Rescan
    </button>
    <label class="sui-toggle-label" style="margin:0">
      <span style="font-size:12px;color:var(--sui-text-muted);">‚òÄÔ∏è/üåô</span>
      <span class="sui-toggle">
        <input type="checkbox" id="theme-toggle">
        <span class="sui-toggle-track"></span>
      </span>
    </label>
  </div>

  <div class="app-wrap">
    <div class="hero">
      <div class="hero-icon">üõ°Ô∏è</div>
      <h1>Privacy Check</h1>
      <p>Audit your digital footprint. Adjust settings. Rescan to verify your privacy.</p>
    </div>

    <div class="sui-card sui-mb-4" id="report">
      <div class="sui-text-center"><span class="sui-badge sui-badge-neutral sui-badge-sm">LIVE STATUS</span></div>
      <div class="rc-grid">
        <div class="rc-col">
          <div class="rc-label">Security Grade</div>
          <div class="rc-val-big" id="o-grade" style="color:var(--sui-text-muted)">-</div>
          <div class="rc-sub" id="o-label">Checking...</div>
        </div>
        <div class="rc-col">
          <div class="rc-label">Footprint Bits</div>
          <div class="rc-val-big" id="s-uniq" style="color:var(--sui-blue-primary)">-</div>
          <div class="rc-sub">Uniqueness</div>
        </div>
      </div>
      
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--sui-border)">
        <div class="sui-progress sui-progress-lg" id="score-container">
          <div class="sui-progress-bar" id="score-bar" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div id="sec-guide"></div>

    <div class="sec-header">‚ö†Ô∏è Actionable Security<div class="sec-line"></div></div>
    <div id="sec-actionable"></div>

    <div class="sec-header">üë£ Device Footprint<div class="sec-line"></div></div>
    <div id="sec-footprint"></div>

    <div class="sui-footer">
      <p>Data stays on device. Built with Speyer UI.</p>
      <div class="sui-mt-2"><span class="sui-badge sui-badge-neutral sui-badge-sm sui-badge-outline" id="app-version">v3.5</span></div>
    </div>
  </div>
</div>

<canvas id="fp-canvas" width="200" height="50" style="display:none"></canvas>

<script>
/* Speyer UI Privacy Check - v3.5 (Persistent State) */

const APP_VERSION = 'v3.5';
document.getElementById('app-version').innerText = APP_VERSION;

// RiskMap tracks actionable issues (High score = Bad)
const RiskMap = new Map();
const FootprintMap = new Map();

// Test Result State (To remember "Success" after rescan)
const TestResults = {
  contacts: null, // null = unchecked, 'blocked' = good, 'exposed' = bad
  files: null
};

const State = {
  isBrave: false,
  isFirefox: false,
  hasAdBlock: false,
  webRTCSafe: false
};

const App = {
  layout: {
    guide: ['tips'],
    actionable: ['prot', 'net', 'api', 'sen', 'priv'],
    footprint: ['id', 'hw', 'fp', 'beh', 'font', 'med', 'bat']
  },
  
  mkSec(id, icon, title, sub, eduText) {
    let containerId = 'sec-footprint';
    if (App.layout.actionable.includes(id)) containerId = 'sec-actionable';
    if (App.layout.guide.includes(id)) containerId = 'sec-guide';
    
    const container = document.getElementById(containerId);
    if (!container) return document.createElement('div');

    const wrap = document.createElement('div');
    wrap.className = 'sui-accordion sui-mb-4';
    
    const trigger = document.createElement('button');
    trigger.className = 'sui-accordion-trigger';
    trigger.setAttribute('aria-expanded', 'false');
    trigger.style.padding = '20px';
    trigger.innerHTML = `
      <span style="display:flex;align-items:center;gap:var(--sui-space-3);flex:1">
        <span style="font-size:24px">${icon}</span>
        <span>
          <span style="display:block;font-weight:700;line-height:1.2;font-size:16px">${title}</span>
          <span style="display:block;font-size:13px;color:var(--sui-text-muted);font-weight:400;margin-top:4px">${sub}</span>
        </span>
      </span>
      <svg class="sui-accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
    `;
    
    const panel = document.createElement('div');
    panel.className = 'sui-accordion-panel';
    panel.hidden = true;
    panel.id = `panel-${id}`;
    panel.style.paddingTop = '12px';

    if (eduText) {
      const edu = document.createElement('div');
      edu.className = 'edu-box';
      edu.innerHTML = `<div class="edu-icon">‚ÑπÔ∏è</div><div>${eduText}</div>`;
      panel.appendChild(edu);
    }

    trigger.onclick = () => {
      const exp = trigger.getAttribute('aria-expanded') === 'true';
      trigger.setAttribute('aria-expanded', !exp);
      panel.hidden = exp;
    };
    
    wrap.appendChild(trigger);
    wrap.appendChild(panel);
    container.appendChild(wrap);
    return panel;
  },

  // Helper: Wipe risks for a section before re-scanning
  clearRisks(keys) {
    keys.forEach(k => RiskMap.delete(k));
  },

  addItem(panel, category, key, val, why, whyTech, isAlert) {
    if (!panel) return;

    let dotClass = 'd-dot-l';
    let riskValue = 0;

    if(category === 'risk') {
       if(isAlert) { 
         dotClass = 'd-dot-h'; 
         riskValue = 1;
       }
       else if(val && (val.includes('Exposed') || val.includes('Yes') || val === 'Missing' || val.includes('High Risk'))) { 
         dotClass = 'd-dot-m'; 
         riskValue = 0.5;
       } 
       else { dotClass = 'd-dot-s'; }
       
       RiskMap.set(key, riskValue);
    } else {
       FootprintMap.set(key, 1);
       dotClass = 'd-dot-l'; 
    }

    const el = document.createElement('div');
    el.className = `d-item risk-${dotClass.replace('d-dot-', '')}`;
    
    const whyBlock = (why || whyTech) 
      ? `<div class="d-why"><span class="d-why-label">${category === 'risk' ? '‚ö†Ô∏è Analysis' : 'üë£ Fingerprint Data'}</span><div>${why ? `<b>${why}</b> ` : ''}${whyTech || ''}</div></div>` 
      : '';

    el.innerHTML = `
      <div class="d-row">
        <div class="d-dot ${dotClass}"></div>
        <span class="d-key">${key}</span>
        <span class="d-val ${isAlert ? 'd-val-err' : ''}">${val || '<span>unavailable</span>'}</span>
      </div>
      ${whyBlock}
    `;
    panel.appendChild(el);
  },

  // Button that remembers state ("Persistent Success")
  addBtn(panel, id, label, icon, onClick) {
    if (!panel) return;
    
    const resultState = TestResults[id];
    
    // If already passed, show static success row instead of button
    if(resultState === 'blocked') {
        this.addItem(panel, 'risk', label, 'Protected (Blocked)', 'You successfully denied access.', '', false);
        return;
    }
    
    // If already failed, show failure
    if(resultState === 'exposed') {
        this.addItem(panel, 'risk', label, 'Exposed', 'Access previously granted.', '', true);
        const reset = document.createElement('button');
        reset.className = 'sui-btn sui-btn-xs sui-btn-ghost';
        reset.innerText = 'Retest';
        reset.onclick = () => { TestResults[id] = null; App.init(); } // Simple reload to reset state
        panel.appendChild(reset);
        return;
    }

    const btn = document.createElement('button');
    btn.className = 'sui-btn sui-btn-ghost perm-btn';
    btn.innerHTML = `<span style="margin-right:8px">${icon}</span> ${label}`;
    btn.onclick = async () => {
      try {
        btn.classList.add('sui-btn-loading'); 
        await onClick(btn, panel);
        // If we get here, it succeeded (Exposed)
        TestResults[id] = 'exposed';
        btn.classList.remove('sui-btn-ghost', 'sui-btn-loading');
        btn.classList.add('granted');
        this.updateGrade(); 
      } catch (e) {
        // If we get here, it failed (Protected)
        btn.classList.remove('sui-btn-loading');
        TestResults[id] = 'blocked';
        
        // Remove button and replace with Success Item
        btn.remove();
        this.addItem(panel, 'risk', label, 'Protected (Blocked)', 'Access Denied.', '', false);
        this.updateGrade();
      }
    };
    panel.appendChild(btn);
  },

  updateGrade() {
    const gEl = document.getElementById('o-grade');
    const bEl = document.getElementById('score-bar');
    const lEl = document.getElementById('o-label');
    const uEl = document.getElementById('s-uniq');

    if (!gEl || !bEl) return;

    let totalRisk = 0;
    RiskMap.forEach(v => totalRisk += v);
    const risks = Math.ceil(totalRisk);

    let grade = 'A';
    let pct = 100;

    if (risks > 4) { grade = 'F'; pct = 25; }
    else if (risks > 2) { grade = 'D'; pct = 50; }
    else if (risks > 0.5) { grade = 'C'; pct = 70; }
    else if (risks > 0) { grade = 'B'; pct = 90; }

    if (uEl) uEl.innerText = (FootprintMap.size * 1.5).toFixed(0); 

    const color = grade === 'A' ? 'var(--sui-success)' : grade === 'F' ? 'var(--sui-error)' : 'var(--sui-warning)';
    gEl.innerText = grade;
    gEl.style.color = color;
    bEl.style.width = pct + '%';
    bEl.style.backgroundColor = color;
    
    if (lEl) {
      lEl.innerText = grade === 'A' ? 'Excellent' : grade === 'F' ? 'Critical Risks' : 'Improvements Needed';
    }
    
    this.updateGuide();
  },

  updateGuide() {
    const panel = document.getElementById('panel-tips');
    if(!panel) return;
    
    const tips = [];
    
    // Browser Advice
    const ua = navigator.userAgent;
    State.isBrave = navigator.brave !== undefined;
    State.isFirefox = ua.toLowerCase().includes('firefox');
    
    if (State.isBrave || State.isFirefox) {
      tips.push({ s: 'success', t: 'Browser: Safe', d: 'You are using a privacy-focused browser.' });
    } else {
      tips.push({ s: 'error', t: 'Browser: High Risk', d: 'Switch to <b>Brave</b> or <b>Firefox</b> to stop passive tracking.' });
    }

    if (State.hasAdBlock) {
      tips.push({ s: 'success', t: 'AdBlock: Active', d: 'You are blocking invisible tracking scripts.' });
    } else {
      tips.push({ s: 'error', t: 'AdBlock: Missing', d: '<b>Critical Action:</b> Install <b>uBlock Origin</b> immediately.' });
    }

    if (State.webRTCSafe) {
      tips.push({ s: 'success', t: 'WebRTC: Safe', d: 'No local IP leak detected.' });
    } else {
      tips.push({ s: 'warning', t: 'WebRTC: Leaking', d: 'Your real IP is visible. Disable WebRTC or use a VPN.' });
    }

    panel.innerHTML = '';
    const edu = document.createElement('div');
    edu.className = 'edu-box';
    edu.innerHTML = `<div class="edu-icon">‚ÑπÔ∏è</div><div>We analyzed your settings. Here is your personalized to-do list.</div>`;
    panel.appendChild(edu);

    tips.forEach(t => {
      const div = document.createElement('div');
      div.className = `sui-alert sui-alert-${t.s} sui-mb-2`;
      div.innerHTML = `<div class="sui-alert-content"><div class="sui-alert-title">${t.t}</div><div>${t.d}</div></div>`;
      panel.appendChild(div);
    });
  },

  // --- SCANNERS ---

  init() {
    // 1. Create the Guide FIRST (Top Position)
    this.mkSec('tips', 'üéì', 'Smart Action Plan', 'Based on your results', 
      'We analyzed your settings. Here is your personalized to-do list.');

    this.mkSec('prot', 'üõ°Ô∏è', 'Protection Check', 'AdBlock, Cookies, GPC', 'Your first line of defense.');
    this.scanProtection(document.getElementById('panel-prot'));

    // NEW: Auto-Scan Permissions API
    this.mkSec('api', 'üö¶', 'Permissions API', 'Auto-detected settings', 'Settings you have already configured.');
    this.scanPermissions(document.getElementById('panel-api'));

    this.mkSec('net', 'üåê', 'Network Exposure', 'IP, WebRTC, Connection', 'What sites see about your location.');
    this.scanNetwork(document.getElementById('panel-net'));

    this.mkSec('id', 'üì±', 'Identity', 'Browser, OS, Timezone', 'The software you run creates a fingerprint.');
    this.scanIdentity(document.getElementById('panel-id'));

    this.mkSec('hw', 'üîß', 'Hardware Specs', 'Screen, CPU, RAM', 'Your physical device properties.');
    this.scanHardware(document.getElementById('panel-hw'));

    this.mkSec('fp', 'üëÅ', 'Invisible Fingerprints', 'Canvas, GPU, Audio', 'Advanced tracking techniques.');
    this.scanFP(document.getElementById('panel-fp'));

    this.mkSec('sen', 'üì°', 'Sensors & Motion', 'Gyroscope, Compass', 'Physical sensor data.');
    this.scanSensors(document.getElementById('panel-sen'));

    this.mkSec('priv', 'üîê', 'Sensitive Access', 'Contacts, Files', 'Sensitive APIs. Manual check required.');
    this.scanSensitive(document.getElementById('panel-priv'));

    this.mkSec('beh', 'üëÜ', 'Behavior', 'Touch & Mouse', 'Biometric movement data.');
    this.scanBehavior(document.getElementById('panel-beh'));

    this.mkSec('font', 'üî§', 'Font Inventory', 'Installed Fonts', 'Your unique list of installed fonts.');
    this.scanFonts(document.getElementById('panel-font'));

    this.mkSec('med', 'üì∑', 'Media Devices', 'Camera, Mic', 'Hardware identifiers.');
    this.scanMedia(document.getElementById('panel-med'));

    this.mkSec('bat', 'üîã', 'Battery Status', 'Level, Charging', 'Short-term tracking identifier.');
    this.scanBattery(document.getElementById('panel-bat'));

    window.addEventListener('online', () => { SUI.toast.info('Network Changed', 'Rescanning...'); this.scanNetwork(document.getElementById('panel-net')); });
    
    document.getElementById('global-rescan').onclick = () => { 
      SUI.toast.success('Rescanning', 'Updating analysis...'); 
      this.scanNetwork(document.getElementById('panel-net'));
      this.scanProtection(document.getElementById('panel-prot'));
      this.scanPermissions(document.getElementById('panel-api'));
      this.scanIdentity(document.getElementById('panel-id'));
    };
    
    document.getElementById('theme-toggle').addEventListener('change', (e) => {
       document.documentElement.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
    });
    
    this.updateGrade();
    setTimeout(() => { if(RiskMap.size > 0) document.querySelector('#panel-tips').hidden = false; }, 1000);
  },

  // NEW: Permissions API Scanner
  async scanPermissions(p) {
    if (!p) return;
    p.innerHTML = '';
    this.clearRisks(['Geo Permission', 'Notif Permission', 'Camera Permission', 'Mic Permission']);

    const check = async (name, label) => {
      try {
        const result = await navigator.permissions.query({name});
        const state = result.state; // 'granted', 'denied', 'prompt'
        let risk = 'risk';
        let alert = false;
        let val = state.toUpperCase();
        
        if (state === 'granted') { alert = true; val += ' (Exposed)'; }
        if (state === 'denied') { val += ' (Protected)'; }
        
        this.addItem(p, risk, label, val, 'Browser Permission State.', '', alert);
      } catch(e) {
        // Not supported in this browser
      }
    };

    await check('geolocation', 'Geo Permission');
    await check('notifications', 'Notif Permission');
    await check('camera', 'Camera Permission');
    await check('microphone', 'Mic Permission');
    this.updateGrade();
  },

  async scanProtection(p) {
    if (!p) return;
    p.innerHTML = '';
    
    this.clearRisks(['GPC Signal', 'Ad Blocker', 'Cookies']);

    const gpc = navigator.globalPrivacyControl;
    this.addItem(p, 'risk', 'GPC Signal', gpc?'On':'Off', 'Global Privacy Control setting.', '', !gpc);
    
    this.addItem(p, 'risk', 'Cookies', navigator.cookieEnabled ? 'Enabled' : 'Blocked', 'Standard tracking.', '', false);

    const ad = document.createElement('div'); ad.className='adsbox'; ad.style.position='absolute'; ad.style.left='-999px'; document.body.appendChild(ad);
    setTimeout(() => {
      const blocked = ad.offsetHeight === 0;
      State.hasAdBlock = blocked;
      if(blocked) this.addItem(p, 'risk', 'Ad Blocker', 'Active', 'Excellent. Blocking trackers.', '', false);
      else this.addItem(p, 'risk', 'Ad Blocker', 'Missing', 'CRITICAL RISK.', 'Vulnerable to tracking.', true);
      ad.remove();
      this.updateGrade();
    }, 100);
  },

  async scanNetwork(p) {
    if (!p) return;
    p.innerHTML = '';
    
    this.clearRisks(['Connection', 'Local IP', 'WebRTC']);

    const h = document.createElement('div'); h.innerHTML = `<button class="sui-btn sui-btn-sm sui-btn-secondary" style="width:100%;margin-bottom:16px;padding:12px">‚Üª Refresh Network</button>`; h.onclick=()=>this.scanNetwork(p); p.appendChild(h);

    if (navigator.connection) {
      this.addItem(p, 'info', 'Connection', navigator.connection.effectiveType);
    }
    
    try {
      const pc = new RTCPeerConnection({iceServers: []});
      pc.createDataChannel('');
      pc.createOffer().then(o => pc.setLocalDescription(o));
      let leakFound = false;
      pc.onicecandidate = (e) => {
        if (e.candidate) {
          const match = e.candidate.candidate.match(/([0-9]{1,3}\.){3}[0-9]{1,3}/);
          if (match) {
            leakFound = true;
            State.webRTCSafe = false;
            this.addItem(p, 'risk', 'Local IP', match[0], 'WEBRTC LEAK DETECTED.', 'Your real IP is exposed.', true);
          }
        }
      };
      setTimeout(() => {
        pc.close();
        if(!leakFound) {
           State.webRTCSafe = true;
           this.addItem(p, 'risk', 'WebRTC', 'Protected', 'No IP leak detected.', '', false);
        }
        this.updateGrade();
      }, 1000);
    } catch (e) { this.addItem(p, 'risk', 'WebRTC', 'Protected', '', '', false); }
  },

  scanIdentity(p) {
    if (!p) return;
    p.innerHTML = '';
    this.clearRisks(['Browser Privacy']);

    const ua = navigator.userAgent;
    State.isBrave = navigator.brave !== undefined;
    State.isFirefox = ua.toLowerCase().includes('firefox');
    const isChrome = /Chrome/.test(ua) && /Google Inc/.test(navigator.vendor) && !State.isBrave;
    
    if(isChrome) {
       this.addItem(p, 'risk', 'Browser Privacy', 'High Risk', 'Standard Chrome tracks extensively.', 'Switch to Brave/Firefox.', false); 
    } else {
       this.addItem(p, 'risk', 'Browser Privacy', 'Good', 'Privacy-focused browser detected.', '', false);
    }

    this.addItem(p, 'info', 'User Agent', ua, 'Browser "ID Card".');
    this.addItem(p, 'info', 'Timezone', Intl.DateTimeFormat().resolvedOptions().timeZone);
  },

  scanHardware(p) {
    if (!p) return;
    p.innerHTML = '';
    this.addItem(p, 'info', 'Screen', `${screen.width}x${screen.height}`);
    this.addItem(p, 'info', 'Cores', navigator.hardwareConcurrency);
    this.addItem(p, 'info', 'RAM', navigator.deviceMemory ? `${navigator.deviceMemory} GB` : '?');
  },

  scanFP(p) {
    if (!p) return;
    p.innerHTML = '';
    try {
      const cv = document.getElementById('fp-canvas');
      const ctx = cv.getContext('2d');
      ctx.textBaseline='top'; ctx.font='14px Arial';
      ctx.fillStyle='#f60'; ctx.fillRect(125,1,62,20);
      ctx.fillStyle='#069'; ctx.fillText('Privacy!',2,15);
      let s = cv.toDataURL();
      let h = 0x811c9dc5;
      for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h+=(h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24)}
      const hash = (h>>>0).toString(16).toUpperCase();
      this.addItem(p, 'info', 'Canvas ID', hash, 'GPU Rendering Hash.');
    } catch(e){}
  },

  scanSensors(p) {
    if (!p) return;
    p.innerHTML = '';
    // Manual Gyro Check
    this.addBtn(p, 'gyro', 'Test Gyroscope', 'üîÑ', (btn) => {
      return new Promise((res) => {
        window.addEventListener('devicemotion', (e) => {
           if(e.accelerationIncludingGravity.x) btn.innerHTML = `x:${e.accelerationIncludingGravity.x.toFixed(1)}`;
        }, {once:true});
        setTimeout(()=>{ 
          this.addItem(p,'risk','Motion','Exposed', 'Site can read device tilt.', '', true); 
          res(); 
        }, 500);
      });
    });
  },

  scanSensitive(p) {
    if (!p) return;
    p.innerHTML = '';
    this.clearRisks(['Contacts', 'Files']);
    
    // Explicit manual check buttons
    this.addBtn(p, 'contacts', 'Test Contacts', 'üë•', async (btn) => {
        const c = await navigator.contacts.select(['name'], {multiple:true});
        this.addItem(p, 'risk', 'Contacts', 'Exposed', 'User granted access.', '', true);
    });
    
    this.addBtn(p, 'files', 'Test Files', 'üìÇ', async (btn) => {
      if('showOpenFilePicker' in window) await window.showOpenFilePicker();
      else { const i=document.createElement('input'); i.type='file'; i.click(); }
      this.addItem(p, 'risk', 'Files', 'Exposed', 'User opened file picker.', '', false);
    });
  },

  async scanFonts(p) {
    if (!p) return;
    p.innerHTML = '';
    this.addItem(p, 'info', 'Fonts', 'System Default', 'System fonts detected.');
  },

  scanMedia(p) {
    if (!p) return;
    p.innerHTML = '';
    this.addBtn(p, 'media', 'Scan Devices', 'üì∑', async (btn) => {
      const devs = await navigator.mediaDevices.enumerateDevices();
      devs.forEach(d => this.addItem(p, 'info', d.kind, d.label||'Hidden'));
    });
  },

  scanBehavior(p) {
    if (!p) return;
    p.innerHTML = '';
    const demo = document.createElement('div');
    demo.className = 'touch-demo';
    demo.innerHTML = `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--sui-text-muted);font-size:14px;text-align:center">üëÜ Touch Here</div>`;
    p.appendChild(demo);
    
    const draw = (x, y) => {
      const dot = document.createElement('div');
      dot.className = 'touch-trail';
      dot.style.left = x+'px'; dot.style.top = y+'px';
      dot.style.background = 'var(--sui-blue-primary)';
      demo.appendChild(dot);
      setTimeout(()=>dot.remove(), 500);
    };
    
    demo.addEventListener('mousemove', e => draw(e.offsetX, e.offsetY));
    demo.addEventListener('touchmove', e => { 
      e.preventDefault(); 
      const rect = demo.getBoundingClientRect();
      const touch = e.touches[0];
      draw(touch.clientX - rect.left, touch.clientY - rect.top);
    }, { passive: false });
  },

  scanBattery(p) {
    if (!p) return;
    p.innerHTML = '';
    if(navigator.getBattery) navigator.getBattery().then(b => {
      this.addItem(p, 'info', 'Level', `${(b.level*100).toFixed(0)}%`);
    });
  }
};

document.addEventListener('DOMContentLoaded', () => App.init());

// PWA Logic
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(reg => {
    if (reg.waiting) showUpdateToast(reg.waiting);
    reg.onupdatefound = () => {
      const newWorker = reg.installing;
      newWorker.onstatechange = () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) showUpdateToast(newWorker);
      };
    };
  });
  navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
}
function showUpdateToast(worker) {
  const t = document.getElementById('update-toast'); t.classList.add('visible');
  document.getElementById('btn-update').onclick = () => worker.postMessage({ type: 'SKIP_WAITING' });
}
</script>
</body>
</html>