<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#3B82F6">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Privacy Check">
<meta name="description" content="Audit your digital footprint. Adjust settings. Rescan to verify your privacy.">

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" href="data:,">

<title>Privacy Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/adrianspeyer/speyer-ui@2.0.7/dist/sui-tokens.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/adrianspeyer/speyer-ui@2.0.7/dist/sui-components.min.css">
<script src="https://cdn.jsdelivr.net/gh/adrianspeyer/speyer-ui@2.0.7/dist/sui.min.js" defer></script>

<style>
/* ‚îÄ‚îÄ PWA Physics ‚îÄ‚îÄ */
body, html { position: fixed; width: 100%; height: 100%; overflow: hidden; background: var(--sui-bg-primary); -webkit-user-select: none; user-select: none; touch-action: pan-y; }
.app-scroller { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: env(safe-area-inset-bottom); overscroll-behavior-y: none; }
.app-wrap { max-width: 640px; margin: 0 auto; padding: 0 var(--sui-space-3) 160px; }

/* ‚îÄ‚îÄ Sticky Action Bar ‚îÄ‚îÄ */
.action-bar {
  position: sticky; top: 0; z-index: 999;
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px var(--sui-space-3); margin: 0 -16px;
  padding-left: calc(var(--sui-space-3) + env(safe-area-inset-left));
  padding-right: calc(var(--sui-space-3) + env(safe-area-inset-right));
  padding-top: calc(12px + env(safe-area-inset-top));
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--sui-border);
}
[data-theme="dark"] .action-bar { background: rgba(11, 15, 26, 0.95); }

.action-left { display: flex; align-items: center; gap: 10px; }

/* Primary button */
.btn-primary {
  background: var(--sui-blue-primary); color: white; border: none;
  border-radius: 24px; padding: 8px 18px;
  font-size: 15px; font-weight: 600;
  display: flex; align-items: center; gap: 8px;
  box-shadow: var(--sui-shadow-sm); cursor: pointer;
}
.btn-primary:active { transform: scale(0.96); }
.btn-primary svg { width: 18px; height: 18px; }

/* Secondary button */
.btn-secondary {
  background: var(--sui-bg-elevated);
  color: var(--sui-text-primary);
  border: 1px solid var(--sui-border);
  border-radius: 24px;
  padding: 8px 14px;
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}
.btn-secondary:active { transform: scale(0.98); }
[data-theme="dark"] .btn-secondary { background: rgba(255,255,255,0.06); }

/* ‚îÄ‚îÄ UI Components ‚îÄ‚îÄ */
.hero { text-align: center; padding: var(--sui-space-5) var(--sui-space-3) 24px; }
.hero-icon { width: 64px; height: 64px; margin: 0 auto 16px; border-radius: var(--sui-radius-lg); background: var(--sui-blue-soft); border: 1px solid var(--sui-border); display: flex; align-items: center; justify-content: center; font-size: 30px; }

/* Report Card */
.rc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
.rc-col { text-align: center; padding: 16px; background: var(--sui-bg-elevated); border-radius: var(--sui-radius-lg); border: 1px solid var(--sui-border); }
.rc-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--sui-text-muted); letter-spacing: 0.05em; margin-bottom: 8px; }
.rc-val-big { font-family: var(--sui-font-mono); font-size: 42px; font-weight: 700; line-height: 1; }
.rc-sub { font-size: 12px; color: var(--sui-text-secondary); margin-top: 6px; font-weight: 500; }

/* Headers */
.sec-header { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--sui-text-muted); margin: 32px 0 12px; padding-left: 4px; display: flex; align-items: center; gap: 8px; }
.sec-line { height: 1px; background: var(--sui-border); flex: 1; }

/* Data Items */
.d-item { background: var(--sui-bg-elevated); border: 1px solid var(--sui-border); border-radius: var(--sui-radius-md); margin-bottom: 16px; overflow: hidden; }
.d-row { display: flex; align-items: flex-start; padding: 16px; gap: 16px; }
.d-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 6px; }
.d-dot-h { background: var(--sui-error); }
.d-dot-m { background: var(--sui-warning); }
.d-dot-s { background: var(--sui-success); }
.d-dot-l { background: var(--sui-info); opacity: 0.5; }
.d-key { font-size: 14px; color: var(--sui-text-secondary); flex-shrink: 0; min-width: 130px; font-weight: 600; }
.d-val { font-family: var(--sui-font-mono); font-size: 14px; color: var(--sui-blue-active); text-align: right; flex: 1; overflow-wrap: anywhere; line-height: 1.6; }
.d-why { padding: 12px 16px; background: rgba(0,0,0,0.03); font-size: 13px; color: var(--sui-text-primary); border-top: 1px solid var(--sui-border); line-height: 1.5; }
.d-why-label { font-weight: 700; font-size: 11px; text-transform: uppercase; color: var(--sui-text-muted); display: block; margin-bottom: 4px; letter-spacing: 0.05em; }

/* Mobile Stack */
@media (max-width: 480px) {
  .d-row { flex-direction: column; gap: 6px; }
  .d-key { min-width: auto; margin-bottom: 2px; color: var(--sui-text-muted); font-size: 12px; text-transform: uppercase; letter-spacing:0.05em;}
  .d-val { text-align: left; width: 100%; font-size: 15px; }
  .d-dot { display: none; }
  .d-item { border-left: 4px solid transparent; }
  .d-item.risk-h { border-left-color: var(--sui-error); }
  .d-item.risk-m { border-left-color: var(--sui-warning); }
  .d-item.risk-s { border-left-color: var(--sui-success); }
  .d-item.risk-l { border-left-color: var(--sui-border); }
}

.edu-box { background: var(--sui-blue-soft); border: 1px solid var(--sui-blue-focus); padding: 16px; border-radius: var(--sui-radius-md); margin-bottom: 16px; font-size: 14px; color: var(--sui-text-primary); line-height: 1.5; display: flex; gap: 12px; }
.edu-icon { font-size: 20px; flex-shrink: 0; margin-top: 0; }

.perm-btn { width: 100%; margin-bottom: 12px; justify-content: flex-start; border-style: dashed; padding: 14px; height: auto; }

/* Behavior demo (was missing in v3.5) */
.touch-demo { position: relative; height: 220px; border: 1px dashed var(--sui-border); border-radius: var(--sui-radius-md); background: var(--sui-bg-card); overflow: hidden; }
.touch-trail { position: absolute; width: 10px; height: 10px; border-radius: 50%; opacity: 0.85; transform: translate(-50%, -50%); }

/* Toast */
.sui-toast-container { z-index: 2000 !important; top: 80px !important; }
.update-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); z-index: 2000; transition: transform 0.3s ease-out; width: 90%; max-width: 400px; }
.update-toast.visible { transform: translateX(-50%) translateY(0); }
</style>
</head>

<body>

<div id="update-toast" class="sui-toast sui-toast-info update-toast">
  <div class="sui-toast-icon">‚ú®</div>
  <div class="sui-toast-content">
    <div class="sui-toast-title">Update Available</div>
    <div class="sui-toast-message">New version ready.</div>
  </div>
  <button class="sui-btn sui-btn-sm sui-btn-primary" id="btn-update">Update</button>
</div>

<div class="app-scroller">
  <div class="action-bar">
    <div class="action-left">
      <button class="btn-primary" id="global-rescan" type="button" aria-label="Rescan">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        Rescan
      </button>

      <button class="btn-secondary" id="btn-vpn-test" type="button" aria-label="VPN Test">
        üß™ VPN Test
      </button>
    </div>

    <label class="sui-toggle-label" style="margin:0">
      <span style="font-size:12px;color:var(--sui-text-muted);">‚òÄÔ∏è/üåô</span>
      <span class="sui-toggle">
        <input type="checkbox" id="theme-toggle">
        <span class="sui-toggle-track"></span>
      </span>
    </label>
  </div>

  <div class="app-wrap">
    <div class="hero">
      <div class="hero-icon">üõ°Ô∏è</div>
      <h1>Privacy Check</h1>
      <p>Audit your digital footprint. Adjust settings. Rescan to verify your privacy.</p>
    </div>

    <div class="sui-card sui-mb-4" id="report">
      <div class="sui-text-center"><span class="sui-badge sui-badge-neutral sui-badge-sm">LIVE STATUS</span></div>
      <div class="rc-grid">
        <div class="rc-col">
          <div class="rc-label">Security Grade</div>
          <div class="rc-val-big" id="o-grade" style="color:var(--sui-text-muted)">-</div>
          <div class="rc-sub" id="o-label">Checking...</div>
        </div>
        <div class="rc-col">
          <div class="rc-label">Footprint Bits</div>
          <div class="rc-val-big" id="s-uniq" style="color:var(--sui-blue-primary)">-</div>
          <div class="rc-sub">Uniqueness</div>
        </div>
      </div>

      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--sui-border)">
        <div class="sui-progress sui-progress-lg">
          <div class="sui-progress-bar" id="score-bar" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div id="sec-guide"></div>

    <div class="sec-header">‚ö†Ô∏è Actionable Security<div class="sec-line"></div></div>
    <div id="sec-actionable"></div>

    <div class="sec-header">üë£ Device Footprint<div class="sec-line"></div></div>
    <div id="sec-footprint"></div>

    <div class="sui-footer">
      <p>Data stays on device. Built with Speyer UI.</p>
      <div class="sui-mt-2"><span class="sui-badge sui-badge-neutral sui-badge-sm sui-badge-outline" id="app-version">v3.8</span></div>
    </div>
  </div>
</div>

<canvas id="fp-canvas" width="200" height="50" style="display:none"></canvas>

<script>
/* Privacy Check ‚Äî v3.8 */

const APP_VERSION = 'v3.8';
document.getElementById('app-version').innerText = APP_VERSION;

// --- Storage ---
const LS_KEY = 'privacy_check_state_v1';
const safeJSONParse = (s) => { try { return JSON.parse(s); } catch(e){ return null; } };
const loadState = () => safeJSONParse(localStorage.getItem(LS_KEY)) || {};
const saveState = (obj) => { try { localStorage.setItem(LS_KEY, JSON.stringify(obj)); } catch(e){} };

const Persist = loadState();
Persist.theme = Persist.theme || null;
Persist.tests = Persist.tests || {};     // permission tests
Persist.vpn = Persist.vpn || {           // vpn/ip test
  lastIp: null,
  prevIp: null,
  lastAt: null,
  prevAt: null,
  status: 'not-tested', // not-tested | first-capture | unchanged | changed
  source: null          // netlify | ipify
};

const RiskMap = new Map();
const FootprintMap = new Map();

const SEV = { none:0, low:0.25, medium:0.5, high:1 };

const State = {
  isBrave: false,
  isFirefox: false,
  hasAdBlock: false
};

// Safe toast (does nothing if SUI not ready yet)
const Toast = {
  info(t,m){ try { window.SUI?.toast?.info?.(t,m); } catch(e){} },
  success(t,m){ try { window.SUI?.toast?.success?.(t,m); } catch(e){} },
  warning(t,m){ try { window.SUI?.toast?.warning?.(t,m); } catch(e){} },
  error(t,m){ try { window.SUI?.toast?.error?.(t,m); } catch(e){} }
};

// --- Theme ---
function setTheme(mode){
  document.documentElement.setAttribute('data-theme', mode);
  Persist.theme = mode;
  saveState(Persist);
}

function initTheme(){
  const toggle = document.getElementById('theme-toggle');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const mode = Persist.theme || (prefersDark ? 'dark' : 'light');
  setTheme(mode);
  toggle.checked = (mode === 'dark');
  toggle.addEventListener('change', (e) => setTheme(e.target.checked ? 'dark' : 'light'));
}

function isPrivateIPv4(ip){
  if (ip.startsWith('10.')) return true;
  if (ip.startsWith('192.168.')) return true;
  if (ip.startsWith('172.')) {
    const n = parseInt(ip.split('.')[1] || '0', 10);
    if (n >= 16 && n <= 31) return true;
  }
  if (ip.startsWith('169.254.')) return true;
  return false;
}

// --- Public IP fetch ---
// Netlify-first (uses your own deploy). Fallback to ipify only when not on Netlify.
const ALLOW_IPIFY_FALLBACK = true;

async function fetchPublicIP(){
  // 1) Netlify Function (best: your own deploy)
  try {
    const r = await fetch('/.netlify/functions/ip', { cache:'no-store' });
    if (r.ok) {
      const j = await r.json();
      if (j && j.ip) return { ip: String(j.ip), source:'netlify' };
    }
  } catch(e){}

  // 2) Optional fallback (only when user clicks VPN Test)
  if (!ALLOW_IPIFY_FALLBACK) throw new Error('IP endpoint unavailable');

  const r2 = await fetch('https://api.ipify.org?format=json', { cache:'no-store' });
  if (!r2.ok) throw new Error('ipify failed');
  const j2 = await r2.json();
  if (!j2 || !j2.ip) throw new Error('ipify missing ip');
  return { ip: String(j2.ip), source:'ipify' };
}

function fmtWhen(ts){
  if (!ts) return '';
  try { return new Date(ts).toLocaleString(); } catch(e){ return ''; }
}

// --- App ---
const App = {
  _bound: false,

  layout: {
    guide: ['tips'],
    actionable: ['prot', 'api', 'net', 'id', 'sen', 'priv'],
    footprint: ['hw', 'fp', 'beh', 'font', 'med', 'bat']
  },

  resetUI(){
    document.getElementById('sec-guide').innerHTML = '';
    document.getElementById('sec-actionable').innerHTML = '';
    document.getElementById('sec-footprint').innerHTML = '';
  },

  resetMaps(){
    RiskMap.clear();
    FootprintMap.clear();
  },

  mkSec(id, icon, title, sub, eduText, open=false) {
    let containerId = 'sec-footprint';
    if (App.layout.actionable.includes(id)) containerId = 'sec-actionable';
    if (App.layout.guide.includes(id)) containerId = 'sec-guide';

    const container = document.getElementById(containerId);
    if (!container) return document.createElement('div');

    const wrap = document.createElement('div');
    wrap.className = 'sui-accordion sui-mb-4';

    const trigger = document.createElement('button');
    trigger.className = 'sui-accordion-trigger';
    trigger.style.padding = '20px';

    const panel = document.createElement('div');
    panel.className = 'sui-accordion-panel';
    panel.id = `panel-${id}`;
    panel.style.paddingTop = '12px';

    trigger.setAttribute('aria-expanded', open ? 'true' : 'false');
    panel.hidden = !open;

    trigger.innerHTML = `
      <span style="display:flex;align-items:center;gap:var(--sui-space-3);flex:1">
        <span style="font-size:24px">${icon}</span>
        <span>
          <span style="display:block;font-weight:700;line-height:1.2;font-size:16px">${title}</span>
          <span style="display:block;font-size:13px;color:var(--sui-text-muted);font-weight:400;margin-top:4px">${sub}</span>
        </span>
      </span>
      <svg class="sui-accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="6 9 12 15 18 9"/>
      </svg>
    `;

    if (eduText) {
      const edu = document.createElement('div');
      edu.className = 'edu-box';
      edu.innerHTML = `<div class="edu-icon">‚ÑπÔ∏è</div><div>${eduText}</div>`;
      panel.appendChild(edu);
    }

    trigger.onclick = () => {
      const exp = trigger.getAttribute('aria-expanded') === 'true';
      trigger.setAttribute('aria-expanded', String(!exp));
      panel.hidden = exp;
    };

    wrap.appendChild(trigger);
    wrap.appendChild(panel);
    container.appendChild(wrap);
    return panel;
  },

  addItem(panel, category, key, val, why, whyTech, severity='none') {
    if (!panel) return;

    let dotClass = 'd-dot-l';

    if (category === 'risk') {
      RiskMap.set(key, SEV[severity] ?? 0);
      dotClass =
        severity === 'high' ? 'd-dot-h' :
        severity === 'medium' ? 'd-dot-m' :
        severity === 'low' ? 'd-dot-l' : 'd-dot-s';
    } else {
      FootprintMap.set(key, 1);
      dotClass = 'd-dot-l';
    }

    const whyBlock = (why || whyTech)
      ? `<div class="d-why">
           <span class="d-why-label">${category === 'risk' ? '‚ö†Ô∏è Analysis' : 'üë£ Fingerprint Data'}</span>
           <div>${why ? `<b>${why}</b> ` : ''}${whyTech || ''}</div>
         </div>`
      : '';

    const el = document.createElement('div');
    el.className = `d-item risk-${dotClass.replace('d-dot-', '')}`;
    el.innerHTML = `
      <div class="d-row">
        <div class="d-dot ${dotClass}"></div>
        <span class="d-key">${key}</span>
        <span class="d-val">${val || '<span>unavailable</span>'}</span>
      </div>
      ${whyBlock}
    `;
    panel.appendChild(el);
  },

  addBtn(panel, id, label, icon, onClick) {
    if (!panel) return;

    const state = Persist.tests[id] || null;

    // Render persistent states
    if (state === 'blocked') {
      this.addItem(panel, 'risk', label, 'Protected (Blocked)', 'You successfully denied access.', '', 'none');
      return;
    }
    if (state === 'exposed') {
      this.addItem(panel, 'risk', label, 'Exposed', 'Access was granted previously.', '', 'high');
      return;
    }

    const btn = document.createElement('button');
    btn.className = 'sui-btn sui-btn-ghost perm-btn';
    btn.innerHTML = `<span style="margin-right:8px">${icon}</span> ${label}`;

    btn.onclick = async () => {
      btn.classList.add('sui-btn-loading');
      try {
        const res = await onClick(btn, panel);

        // If user cancels, do NOT mark exposed
        if (res && res.status === 'cancelled') {
          btn.classList.remove('sui-btn-loading');
          Toast.info('Cancelled', 'No access granted.');
          return;
        }

        Persist.tests[id] = 'exposed';
        saveState(Persist);
        btn.classList.remove('sui-btn-loading');
        Toast.warning('Granted', 'This permission can expose sensitive data.');
        this.render(); // re-render to show persistent row
      } catch (e) {
        Persist.tests[id] = 'blocked';
        saveState(Persist);
        btn.classList.remove('sui-btn-loading');
        Toast.success('Protected', 'Access denied or unavailable.');
        this.render();
      }
    };

    panel.appendChild(btn);
  },

  updateGrade() {
    const gEl = document.getElementById('o-grade');
    const bEl = document.getElementById('score-bar');
    const lEl = document.getElementById('o-label');
    const uEl = document.getElementById('s-uniq');
    if (!gEl || !bEl) return;

    let total = 0;
    RiskMap.forEach(v => total += (Number(v) || 0));

    let grade = 'A';
    if (total >= 4) grade = 'F';
    else if (total >= 3) grade = 'D';
    else if (total >= 2) grade = 'C';
    else if (total >= 1) grade = 'B';

    const pct = grade === 'A' ? 100 : grade === 'B' ? 90 : grade === 'C' ? 70 : grade === 'D' ? 50 : 25;

    if (uEl) uEl.innerText = (FootprintMap.size * 1.5).toFixed(0);

    const color = grade === 'A' ? 'var(--sui-success)' : grade === 'F' ? 'var(--sui-error)' : 'var(--sui-warning)';
    gEl.innerText = grade;
    gEl.style.color = color;
    bEl.style.width = pct + '%';
    bEl.style.backgroundColor = color;

    if (lEl) {
      lEl.innerText =
        grade === 'A' ? 'Excellent' :
        grade === 'B' ? 'Good (Minor Fixes)' :
        grade === 'C' ? 'Needs Work' :
        grade === 'D' ? 'High Risk Setup' : 'Critical Risks';
    }
  },

  updateGuide(panelTips){
    if (!panelTips) return;

    const tips = [];

    const ua = navigator.userAgent || '';
    State.isBrave = navigator.brave !== undefined;
    State.isFirefox = ua.toLowerCase().includes('firefox');

    if (State.isBrave || State.isFirefox) {
      tips.push({ s:'success', t:'Browser', d:'Privacy-focused browser detected.' });
    } else {
      tips.push({ s:'warning', t:'Browser', d:'Consider Brave or Firefox for stronger default privacy.' });
    }

    if (State.hasAdBlock) {
      tips.push({ s:'success', t:'Ad Blocking', d:'Many tracking scripts will be blocked.' });
    } else {
      tips.push({ s:'error', t:'Ad Blocking', d:'Install an ad/tracker blocker for a major privacy win.' });
    }

    // VPN status is only graded after two captures (so it doesn‚Äôt punish people who never touch it)
    if (Persist.vpn.status === 'changed') {
      tips.push({ s:'success', t:'VPN / Route', d:'Your exit route changed since last check (often a VPN signal).' });
    } else if (Persist.vpn.status === 'unchanged') {
      tips.push({ s:'warning', t:'VPN / Route', d:'No route change detected. If you expected VPN, re-check with VPN on.' });
    }

    panelTips.innerHTML = '';
    const edu = document.createElement('div');
    edu.className = 'edu-box';
    edu.innerHTML = `<div class="edu-icon">‚ÑπÔ∏è</div><div>We analyzed your setup. Here‚Äôs your quick action plan.</div>`;
    panelTips.appendChild(edu);

    tips.forEach(t => {
      const div = document.createElement('div');
      div.className = `sui-alert sui-alert-${t.s} sui-mb-2`;
      div.innerHTML = `<div class="sui-alert-content"><div class="sui-alert-title">${t.t}</div><div>${t.d}</div></div>`;
      panelTips.appendChild(div);
    });
  },

  // ---------------- Scanners ----------------

  async scanProtection(p) {
    p.innerHTML = '';

    const gpc = !!navigator.globalPrivacyControl;
    this.addItem(p,'risk','GPC Signal', gpc ? 'On' : 'Off',
      'Global Privacy Control can signal ‚ÄúDo Not Sell/Share‚Äù.',
      '', gpc ? 'none' : 'medium');

    const cookiesOn = !!navigator.cookieEnabled;
    this.addItem(p,'risk','Cookies', cookiesOn ? 'Enabled' : 'Blocked',
      'Cookies can be used for tracking unless blocked/partitioned.',
      '', cookiesOn ? 'medium' : 'none');

    // More reliable adblock bait
    const bait = document.createElement('div');
    bait.className = 'adsbox ad ads-banner adsbygoogle ad-placement';
    bait.style.cssText = 'width:12px;height:12px;position:absolute;left:-9999px;top:0;background:#f00;';
    bait.innerHTML = '&nbsp;';
    document.body.appendChild(bait);

    await new Promise(r => setTimeout(r, 80));

    const cs = window.getComputedStyle(bait);
    const blocked =
      cs.display === 'none' ||
      cs.visibility === 'hidden' ||
      bait.offsetParent === null ||
      bait.offsetHeight === 0;

    bait.remove();

    State.hasAdBlock = blocked;

    this.addItem(p,'risk','Ad Blocker', blocked ? 'Active' : 'Missing',
      blocked ? 'Great: many trackers will be blocked.' : 'Trackers will load normally.',
      blocked ? '' : 'Installing a blocker is one of the highest-impact privacy wins.',
      blocked ? 'none' : 'high');
  },

  async scanPermissions(p) {
    p.innerHTML = '';

    if (!navigator.permissions?.query) {
      this.addItem(p,'info','Permissions API','Unavailable','This browser does not expose permission states via API.');
      return;
    }

    const check = async (name,label,sevIfGranted) => {
      try {
        const r = await navigator.permissions.query({ name });
        const s = r.state;
        let val = s.toUpperCase();
        let sev = 'none';

        if (s === 'granted'){ val += ' (Exposed)'; sev = sevIfGranted; }
        if (s === 'denied'){ val += ' (Protected)'; sev = 'none'; }
        if (s === 'prompt'){ val += ' (Not Granted)'; sev = 'none'; }

        this.addItem(p,'risk',label,val,'Permission state detected by your browser.','',sev);
      } catch(e) {
        this.addItem(p,'info',label,'Not Supported','This permission type isn‚Äôt exposed in this browser.');
      }
    };

    await check('geolocation','Geo Permission','high');
    await check('notifications','Notif Permission','medium');
    await check('camera','Camera Permission','high');
    await check('microphone','Mic Permission','high');
  },

  async scanNetwork(p) {
    p.innerHTML = '';

    // Connection (informational)
    if (navigator.connection?.effectiveType) {
      this.addItem(p,'info','Connection', navigator.connection.effectiveType, 'Rough network category (not precise).');
    }

    // WebRTC: detect if a PUBLIC candidate appears (risk)
    // Note: behavior varies by browser/privacy settings.
    let webRtcPublic = false;
    let candidates = new Set();

    try {
      const pc = new RTCPeerConnection({ iceServers: [] });
      pc.createDataChannel('x');

      pc.onicecandidate = (e) => {
        if (!e.candidate?.candidate) return;

        // IPv4 extraction
        const m4 = e.candidate.candidate.match(/([0-9]{1,3}\.){3}[0-9]{1,3}/);
        if (m4) candidates.add(m4[0]);

        // Basic IPv6 extraction (not exhaustive)
        const m6 = e.candidate.candidate.match(/([a-f0-9:]+:+)+[a-f0-9]+/i);
        if (m6 && m6[0].includes(':')) candidates.add(m6[0]);
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      await new Promise(r => setTimeout(r, 900));
      pc.close();

      // Evaluate public IPv4 only (safe + simple)
      const ips = Array.from(candidates).filter(x => x.includes('.'));
      if (ips.length) {
        const anyPublic = ips.some(ip => !isPrivateIPv4(ip));
        webRtcPublic = anyPublic;

        this.addItem(
          p,
          webRtcPublic ? 'risk' : 'info',
          'WebRTC Candidates',
          ips.slice(0, 6).join(', '),
          webRtcPublic ? 'A public IP appeared in WebRTC candidates.' : 'Candidates observed (often local/private).',
          webRtcPublic ? 'Consider disabling WebRTC or using stricter browser privacy settings.' : '',
          webRtcPublic ? 'high' : 'none'
        );
      } else {
        this.addItem(p,'info','WebRTC Candidates','None observed','Some browsers restrict candidate visibility.');
      }
    } catch(e) {
      this.addItem(p,'info','WebRTC','Unavailable','WebRTC is blocked or unsupported in this browser.');
    }

    // VPN / Route Test (user-initiated)
    const status = Persist.vpn.status;
    const last = Persist.vpn.lastIp;
    const prev = Persist.vpn.prevIp;

    const statusLabel =
      status === 'changed' ? 'Changed (Likely VPN / network change)' :
      status === 'unchanged' ? 'Unchanged' :
      status === 'first-capture' ? 'Captured once (toggle VPN and test again)' :
      'Not tested';

    // Only grade AFTER two captures
    if (status === 'unchanged') {
      this.addItem(p,'risk','VPN / Route', statusLabel,
        'No change detected since last capture.',
        'If you expected VPN, enable it and press VPN Test again.',
        'low');
    } else if (status === 'changed') {
      this.addItem(p,'risk','VPN / Route', statusLabel,
        'Your exit route changed since the last capture.',
        'This often happens when a VPN is enabled (or when switching networks).',
        'none');
    } else {
      this.addItem(p,'info','VPN / Route', statusLabel,
        'This test only runs when you press VPN Test.',
        'It compares two captured public IPs.');
    }

    this.addItem(
      p,
      'info',
      'Public IP (last)',
      last ? `${last} ¬∑ ${fmtWhen(Persist.vpn.lastAt)}${Persist.vpn.source ? ` ¬∑ ${Persist.vpn.source}` : ''}` : 'Not captured',
      'Public IP is your ‚Äúinternet-facing‚Äù address.'
    );

    this.addItem(
      p,
      'info',
      'Public IP (previous)',
      prev ? `${prev} ¬∑ ${fmtWhen(Persist.vpn.prevAt)}` : '‚Äî',
      'Used to compare whether your exit route changed.'
    );

    // Controls
    const controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.style.gap = '10px';
    controls.style.marginTop = '12px';

    const btnCapture = document.createElement('button');
    btnCapture.className = 'sui-btn sui-btn-sm sui-btn-secondary';
    btnCapture.style.flex = '1';
    btnCapture.textContent = 'Capture / Compare IP';

    const btnReset = document.createElement('button');
    btnReset.className = 'sui-btn sui-btn-sm sui-btn-ghost';
    btnReset.style.flex = '1';
    btnReset.textContent = 'Reset VPN Test';

    btnCapture.onclick = async () => {
      btnCapture.classList.add('sui-btn-loading');
      try {
        const { ip, source } = await fetchPublicIP();

        // shift last -> prev
        Persist.vpn.prevIp = Persist.vpn.lastIp;
        Persist.vpn.prevAt = Persist.vpn.lastAt;

        Persist.vpn.lastIp = ip;
        Persist.vpn.lastAt = Date.now();
        Persist.vpn.source = source;

        if (!Persist.vpn.prevIp) Persist.vpn.status = 'first-capture';
        else Persist.vpn.status = (Persist.vpn.prevIp === Persist.vpn.lastIp) ? 'unchanged' : 'changed';

        saveState(Persist);

        Toast.success('VPN Test', 'Captured public IP.');
        await this.render(); // re-render so grade updates
      } catch(e) {
        console.error(e);
        Toast.error('VPN Test', 'IP check failed (Netlify function not available?).');
      } finally {
        btnCapture.classList.remove('sui-btn-loading');
      }
    };

    btnReset.onclick = async () => {
      Persist.vpn = { lastIp:null, prevIp:null, lastAt:null, prevAt:null, status:'not-tested', source:null };
      saveState(Persist);
      Toast.info('Reset', 'VPN test state cleared.');
      await this.render();
    };

    controls.appendChild(btnCapture);
    controls.appendChild(btnReset);
    p.appendChild(controls);

    // Add an education note (after controls)
    const hint = document.createElement('div');
    hint.className = 'edu-box';
    hint.innerHTML = `<div class="edu-icon">üß™</div><div><b>How to test:</b> Capture once with VPN off, enable VPN, then press VPN Test again. If the IP changes, we mark it as a likely VPN / route change.</div>`;
    p.appendChild(hint);
  },

  scanIdentity(p) {
    p.innerHTML = '';

    const ua = navigator.userAgent || '';
    State.isBrave = navigator.brave !== undefined;
    State.isFirefox = ua.toLowerCase().includes('firefox');
    const isChrome = /Chrome/.test(ua) && /Google Inc/.test(navigator.vendor || '') && !State.isBrave;

    this.addItem(
      p,'risk','Browser Privacy',
      isChrome ? 'Standard Chrome' : 'Privacy-Focused (Detected)',
      isChrome ? 'Chrome defaults are less privacy-protective.' : 'A privacy-focused browser was detected.',
      isChrome ? 'Brave/Firefox generally reduce passive tracking by default.' : '',
      isChrome ? 'medium' : 'none'
    );

    this.addItem(p,'info','User Agent', ua, 'Browser ‚ÄúID card‚Äù (often unique).');
    this.addItem(p,'info','Timezone', Intl.DateTimeFormat().resolvedOptions().timeZone || 'unknown', 'Timezone can help identify you.');
  },

  scanHardware(p) {
    p.innerHTML = '';
    this.addItem(p,'info','Screen', `${screen.width}x${screen.height}`, 'Screen size can help identify a device.');
    this.addItem(p,'info','CPU Cores', navigator.hardwareConcurrency || 'unknown', 'Hardware signal (not graded).');
    this.addItem(p,'info','RAM', navigator.deviceMemory ? `${navigator.deviceMemory} GB` : 'unknown', 'Hardware signal (not graded).');
  },

  scanFP(p) {
    p.innerHTML = '';
    try {
      const cv = document.getElementById('fp-canvas');
      const ctx = cv.getContext('2d');
      ctx.textBaseline='top'; ctx.font='14px Arial';
      ctx.fillStyle='#f60'; ctx.fillRect(125,1,62,20);
      ctx.fillStyle='#069'; ctx.fillText('Privacy!',2,15);
      const s = cv.toDataURL();
      let h = 0x811c9dc5;
      for (let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24); }
      const hash = (h>>>0).toString(16).toUpperCase();
      this.addItem(p,'info','Canvas ID', hash, 'Rendering-based fingerprint signal.');
    } catch(e) {
      this.addItem(p,'info','Canvas ID','Unavailable','Canvas fingerprint test failed.');
    }
  },

  scanBehavior(p) {
    p.innerHTML = '';
    const demo = document.createElement('div');
    demo.className = 'touch-demo';
    demo.innerHTML = `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--sui-text-muted);font-size:14px;text-align:center">üëÜ Touch / Move Here</div>`;
    p.appendChild(demo);

    const draw = (x, y) => {
      const dot = document.createElement('div');
      dot.className = 'touch-trail';
      dot.style.left = x+'px';
      dot.style.top = y+'px';
      dot.style.background = 'var(--sui-blue-primary)';
      demo.appendChild(dot);
      setTimeout(()=>dot.remove(), 500);
    };

    demo.addEventListener('mousemove', e => draw(e.offsetX, e.offsetY));
    demo.addEventListener('touchmove', e => {
      e.preventDefault();
      const rect = demo.getBoundingClientRect();
      const t = e.touches[0];
      draw(t.clientX - rect.left, t.clientY - rect.top);
    }, { passive: false });

    this.addItem(p,'info','Demo','Active','Movement data can be captured and modeled over time.');
  },

  scanFonts(p) {
    p.innerHTML = '';
    this.addItem(p, 'info', 'Fonts', 'System Default', 'Font availability can be used for fingerprinting.');
  },

  scanMedia(p) {
    p.innerHTML = '';
    this.addBtn(p, 'media', 'Scan Devices', 'üì∑', async () => {
      if (!navigator.mediaDevices?.enumerateDevices) throw new Error('MediaDevices not supported');
      const devs = await navigator.mediaDevices.enumerateDevices();
      devs.forEach(d => this.addItem(p,'info', d.kind, d.label || 'Hidden', 'Device labels are often hidden until permission is granted.'));
      return { status:'exposed' };
    });
  },

  scanBattery(p) {
    p.innerHTML = '';
    if (navigator.getBattery) {
      navigator.getBattery().then(b => {
        this.addItem(p,'info','Level', `${(b.level*100).toFixed(0)}%`, 'Battery can be used as a short-lived identifier.');
      });
    } else {
      this.addItem(p,'info','Battery','Unavailable','Battery API not exposed in this browser.');
    }
  },

  scanSensors(p) {
    p.innerHTML = '';
    this.addBtn(p, 'motion', 'Test Motion / Gyroscope', 'üì°', async () => {
      try {
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
          const resp = await DeviceMotionEvent.requestPermission();
          if (resp !== 'granted') return { status:'cancelled' };
        }
        let got = false;
        const handler = () => { got = true; };
        window.addEventListener('devicemotion', handler, { once:true });
        await new Promise(r => setTimeout(r, 900));
        window.removeEventListener('devicemotion', handler);

        if (got) {
          this.addItem(p,'risk','Motion','Exposed','Motion sensors can be read when allowed.','', 'medium');
          return { status:'exposed' };
        }
        return { status:'cancelled' };
      } catch(e) {
        return { status:'cancelled' };
      }
    });
  },

  scanSensitive(p) {
    p.innerHTML = '';

    this.addBtn(p, 'contacts', 'Test Contacts', 'üë•', async () => {
      if (!navigator.contacts?.select) throw new Error('Contacts API not supported');
      try {
        await navigator.contacts.select(['name'], { multiple:true });
        this.addItem(p,'risk','Contacts','Exposed','You granted access to contacts.','', 'high');
        return { status:'exposed' };
      } catch(e) {
        if (e && (e.name === 'AbortError' || String(e).toLowerCase().includes('abort'))) return { status:'cancelled' };
        throw e;
      }
    });

    this.addBtn(p, 'files', 'Test File Picker', 'üìÇ', async () => {
      try {
        if ('showOpenFilePicker' in window) await window.showOpenFilePicker();
        else { const i=document.createElement('input'); i.type='file'; i.click(); }
        this.addItem(p,'risk','Files','Exposed','You opened a file picker (user-initiated access).','', 'medium');
        return { status:'exposed' };
      } catch(e) {
        if (e && (e.name === 'AbortError' || String(e).toLowerCase().includes('abort'))) return { status:'cancelled' };
        throw e;
      }
    });
  },

  async render(){
    this.resetUI();
    this.resetMaps();

    // Guide
    const tipsPanel = this.mkSec(
      'tips','üéì','Smart Action Plan','Based on your results',
      'Your grade is based on actionable security checks.', true
    );

    // Actionable Security
    const pProt = this.mkSec('prot','üõ°Ô∏è','Protection Check','AdBlock, Cookies, GPC','Your first line of defense.');
    await this.scanProtection(pProt);

    const pApi = this.mkSec('api','üö¶','Permissions API','Auto-detected settings','Permissions you already configured.');
    await this.scanPermissions(pApi);

    const pNet = this.mkSec('net','üåê','Network Exposure','WebRTC + VPN Test','Network signals sites can infer.');
    await this.scanNetwork(pNet);

    const pId = this.mkSec('id','üì±','Identity','Browser + Timezone','Software identity signals.');
    this.scanIdentity(pId);

    const pSen = this.mkSec('sen','üì°','Sensors & Motion','Motion test','Only runs when you tap.');
    this.scanSensors(pSen);

    const pPriv = this.mkSec('priv','üîê','Sensitive Access','Contacts, Files','Only runs when you tap.');
    this.scanSensitive(pPriv);

    // Footprint
    const pHw = this.mkSec('hw','üîß','Hardware Specs','Screen, CPU, RAM','Uniqueness signals (not graded).');
    this.scanHardware(pHw);

    const pFp = this.mkSec('fp','üëÅ','Invisible Fingerprints','Canvas','Rendering quirks trackers can use.');
    this.scanFP(pFp);

    const pBeh = this.mkSec('beh','üëÜ','Behavior','Touch & Mouse','Biometric-style movement signals.');
    this.scanBehavior(pBeh);

    const pFont = this.mkSec('font','üî§','Font Inventory','High-level signal','Font presence can be fingerprinting data.');
    this.scanFonts(pFont);

    const pMed = this.mkSec('med','üì∑','Media Devices','Camera, Mic','Labels may be hidden until permission.');
    this.scanMedia(pMed);

    const pBat = this.mkSec('bat','üîã','Battery Status','Level, Charging','Short-term identifier.');
    this.scanBattery(pBat);

    // Update guide + grade
    this.updateGuide(tipsPanel);
    this.updateGrade();
  },

  bindOnce(){
    if (this._bound) return;
    this._bound = true;

    // Rescan: re-render everything safely
    document.getElementById('global-rescan').addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        Toast.success('Rescanning', 'Updating analysis‚Ä¶');
        await this.render();
      } catch(err) {
        console.error(err);
        Toast.error('Rescan Failed', 'Check console for details.');
      }
    });

    // VPN Test: scroll to Network + run capture/compare
    document.getElementById('btn-vpn-test').addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        // open Network section (best effort)
        const netTrigger = document.querySelector('[aria-expanded][class*="sui-accordion-trigger"]');
        // We won't force open all; the Network section includes its own buttons.
        Toast.info('VPN Test', 'Open ‚ÄúNetwork Exposure‚Äù and press ‚ÄúCapture / Compare IP‚Äù.');
        const netHeader = document.querySelector('#sec-actionable');
        if (netHeader) netHeader.scrollIntoView({ behavior:'smooth', block:'start' });
      } catch(err) {}
    });
  },

  async init(){
    initTheme();
    this.bindOnce();
    await this.render();
  }
};

document.addEventListener('DOMContentLoaded', () => App.init());

// PWA Logic
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(reg => {
    if (reg.waiting) showUpdateToast(reg.waiting);
    reg.onupdatefound = () => {
      const newWorker = reg.installing;
      newWorker.onstatechange = () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) showUpdateToast(newWorker);
      };
    };
  });
  navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
}

function showUpdateToast(worker) {
  const t = document.getElementById('update-toast');
  t.classList.add('visible');
  document.getElementById('btn-update').onclick = () => worker.postMessage({ type: 'SKIP_WAITING' });
}
</script>

</body>
</html>
